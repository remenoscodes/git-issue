name: Test Installation

on:
  push:
    branches: [ main ]
    paths:
      - 'install.sh'
      - 'Makefile'
      - 'bin/**'
      - 'PKGBUILD'
      - 'Formula/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-install-script:
    name: Test install.sh on ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu:22.04
          - ubuntu:20.04
          - debian:12
          - debian:11
          - alpine:latest
          - archlinux:latest

    container:
      image: ${{ matrix.os }}

    steps:
      - name: Install dependencies (Ubuntu/Debian)
        if: startsWith(matrix.os, 'ubuntu') || startsWith(matrix.os, 'debian')
        run: |
          apt-get update
          apt-get install -y git make

      - name: Install dependencies (Alpine)
        if: startsWith(matrix.os, 'alpine')
        run: |
          apk add --no-cache git make bash

      - name: Install dependencies (Arch)
        if: startsWith(matrix.os, 'archlinux')
        run: |
          pacman -Syu --noconfirm git make

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test install.sh (user install)
        run: |
          # Test user installation
          ./install.sh "$HOME/.local"

          # Verify binaries installed
          test -f "$HOME/.local/bin/git-issue" || exit 1
          test -x "$HOME/.local/bin/git-issue" || exit 1

          # Verify all subcommands installed
          for cmd in create ls show comment edit state search import export sync merge fsck init; do
            test -f "$HOME/.local/bin/git-issue-$cmd" || exit 1
            test -x "$HOME/.local/bin/git-issue-$cmd" || exit 1
          done

          echo "✓ User installation succeeded"

      - name: Test version command
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          VERSION_OUTPUT="$(git-issue version)"
          echo "Version output: $VERSION_OUTPUT"

          # Verify version matches expected
          echo "$VERSION_OUTPUT" | grep -q "1.0.1" || exit 1
          echo "✓ Version command works"

      - name: Test basic commands
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Initialize git repo for testing
          mkdir -p /tmp/test-repo
          cd /tmp/test-repo
          git init
          git config user.name "Test User"
          git config user.email "test@example.com"

          # Add dummy remote (git-issue init requires a remote)
          git remote add origin https://example.com/test.git

          # Test init command
          git-issue init || exit 1
          echo "✓ git-issue init works"

          # Test successful - installation validated
          echo "✓ Installation test complete"

      - name: Test Makefile installation (system-wide simulation)
        run: |
          # Clean previous user install
          rm -rf "$HOME/.local/bin/git-issue"*

          # Test make install to a temporary prefix
          make install prefix=/tmp/install-test

          # Verify installation
          test -f /tmp/install-test/bin/git-issue || exit 1
          test -x /tmp/install-test/bin/git-issue || exit 1

          echo "✓ Makefile installation succeeded"

  test-macos-install:
    name: Test installation on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test install.sh (user install)
        run: |
          ./install.sh "$HOME/.local"

          # Verify binaries installed
          test -f "$HOME/.local/bin/git-issue" || exit 1
          test -x "$HOME/.local/bin/git-issue" || exit 1

          echo "✓ macOS user installation succeeded"

      - name: Test version command
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          git-issue version | grep -q "1.0.1" || exit 1
          echo "✓ Version command works on macOS"

      - name: Test basic functionality
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Initialize git repo
          mkdir -p /tmp/test-repo
          cd /tmp/test-repo
          git init
          git config user.name "Test User"
          git config user.email "test@example.com"

          # Add dummy remote (git-issue init requires a remote)
          git remote add origin https://example.com/test.git

          # Test init
          git-issue init || exit 1
          echo "✓ git-issue init works on macOS"

          # Test successful - installation validated
          echo "✓ macOS installation test complete"

  test-homebrew-formula:
    name: Test Homebrew formula
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test formula syntax
        run: |
          # Validate formula Ruby syntax
          ruby -c Formula/git-native-issue.rb || exit 1
          echo "✓ Formula syntax valid"

      - name: Test formula installation (from tap)
        run: |
          # Uninstall if already installed
          brew uninstall git-native-issue 2>/dev/null || true

          # Install from actual tap
          brew install remenoscodes/git-native-issue/git-native-issue || exit 1

          # Verify installation
          git-issue version | grep -q "1.0.1" || exit 1
          echo "✓ Homebrew tap installation works"

          # Test successful - Homebrew installation validated
          echo "✓ Homebrew test complete"

  test-asdf-plugin:
    name: Test asdf plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install asdf
        run: |
          git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.0
          echo '. "$HOME/.asdf/asdf.sh"' >> ~/.bashrc
          echo '. "$HOME/.asdf/completions/asdf.bash"' >> ~/.bashrc

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git jq

      - name: Test plugin installation
        shell: bash
        run: |
          source ~/.asdf/asdf.sh

          # Add plugin from GitHub
          asdf plugin add git-native-issue https://github.com/remenoscodes/git-native-issue-asdf.git

          # List available versions
          asdf list-all git-native-issue | grep -q "1.0.1" || exit 1
          echo "✓ Plugin can list versions"

          # Install specific version
          asdf install git-native-issue 1.0.1
          echo "✓ Version 1.0.1 installed"

          # Set global version
          asdf global git-native-issue 1.0.1

          # Verify installation
          git-issue version | grep -q "1.0.1" || exit 1
          echo "✓ asdf plugin test complete"

  test-pkgbuild:
    name: Test PKGBUILD (Arch Linux)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm base-devel git

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build user
        run: |
          # makepkg cannot run as root
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Validate PKGBUILD syntax
        run: |
          su - builder -c "cd $GITHUB_WORKSPACE && bash -n PKGBUILD"
          echo "✓ PKGBUILD syntax valid"

      - name: Build package
        run: |
          su - builder -c "cd $GITHUB_WORKSPACE && makepkg -s --noconfirm"
          echo "✓ Package built successfully"

      - name: Install package
        run: |
          # Find and install the built package
          PKGFILE=$(find $GITHUB_WORKSPACE -name "git-issue-*.pkg.tar.zst" | head -1)
          pacman -U --noconfirm "$PKGFILE"
          echo "✓ Package installed"

      - name: Test installation
        run: |
          # Verify binaries installed
          test -f /usr/bin/git-issue || exit 1
          test -x /usr/bin/git-issue || exit 1

          # Check version
          git-issue version | grep -q "1.0.1" || exit 1
          echo "✓ PKGBUILD test complete"
