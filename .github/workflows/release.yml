name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          # Use GITHUB_TOKEN with write permissions for pushing formula update
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Get version from tag
        id: tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "version_number=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Verify version in code matches tag
        run: |
          CODE_VERSION=$(grep -E '^VERSION=' bin/git-issue 2>/dev/null || echo "")
          if [ -z "$CODE_VERSION" ]; then
            echo "Warning: No VERSION variable found in bin/git-issue"
          else
            CODE_VERSION=$(echo "$CODE_VERSION" | sed 's/VERSION="\(.*\)"/\1/')
            TAG_VERSION="${{ steps.tag.outputs.version_number }}"
            if [ "$CODE_VERSION" != "$TAG_VERSION" ]; then
              echo "Error: Version mismatch!"
              echo "  Tag version: $TAG_VERSION"
              echo "  Code version: $CODE_VERSION"
              echo "Please update VERSION in bin/git-issue to match the tag"
              exit 1
            fi
            echo "✓ Version matches: $CODE_VERSION"
          fi

      - name: Create tarball
        run: |
          mkdir -p git-issue-${{ steps.tag.outputs.version }}

          # Copy all necessary files
          cp -r bin/ git-issue-${{ steps.tag.outputs.version }}/
          cp Makefile git-issue-${{ steps.tag.outputs.version }}/
          cp LICENSE git-issue-${{ steps.tag.outputs.version }}/
          cp README.md git-issue-${{ steps.tag.outputs.version }}/
          cp ISSUE-FORMAT.md git-issue-${{ steps.tag.outputs.version }}/
          cp install.sh git-issue-${{ steps.tag.outputs.version }}/

          # Copy documentation if it exists
          if [ -d doc ]; then
            cp -r doc/ git-issue-${{ steps.tag.outputs.version }}/
          fi

          # Copy Formula for reference
          if [ -d Formula ]; then
            cp -r Formula/ git-issue-${{ steps.tag.outputs.version }}/
          fi

          # Create tarball
          tar czf git-issue-${{ steps.tag.outputs.version }}.tar.gz \
            git-issue-${{ steps.tag.outputs.version }}/

          # Compute SHA256
          SHA256=$(shasum -a 256 git-issue-${{ steps.tag.outputs.version }}.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "tarball=git-issue-${{ steps.tag.outputs.version }}.tar.gz" >> "$GITHUB_OUTPUT"

          echo "✓ Tarball created: git-issue-${{ steps.tag.outputs.version }}.tar.gz"
          echo "✓ SHA256: ${SHA256}"
        id: tarball

      - name: Test tarball installation
        run: |
          # Extract tarball
          tar xzf git-issue-${{ steps.tag.outputs.version }}.tar.gz
          cd git-issue-${{ steps.tag.outputs.version }}

          # Test make install
          make install prefix="${{ runner.temp }}/test-install"

          # Verify binaries installed
          test -f "${{ runner.temp }}/test-install/bin/git-issue" || exit 1
          test -x "${{ runner.temp }}/test-install/bin/git-issue" || exit 1

          # Test version command (if VERSION is in code)
          if grep -q "^VERSION=" bin/git-issue; then
            PATH="${{ runner.temp }}/test-install/bin:$PATH" git-issue version || true
          fi

          echo "✓ Tarball installation verified"

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## What's Changed" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          else
            echo "## Initial Release" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Add installation instructions
          {
            echo ""
            echo "## Installation"
            echo ""
            echo "### Homebrew (macOS/Linux)"
            echo '```bash'
            echo "brew install remenoscodes/git-issue/git-issue"
            echo '```'
            echo ""
            echo "### Install Script (Any POSIX System)"
            echo '```bash'
            echo "curl -sSL https://github.com/remenoscodes/git-issue/releases/download/${{ steps.tag.outputs.version }}/git-issue-${{ steps.tag.outputs.version }}.tar.gz | tar xz"
            echo "cd git-issue-${{ steps.tag.outputs.version }}"
            echo "sudo make install"
            echo '```'
            echo ""
            echo "### From Tarball"
            echo "Download \`git-issue-${{ steps.tag.outputs.version }}.tar.gz\` below, extract, and run:"
            echo '```bash'
            echo "tar xzf git-issue-${{ steps.tag.outputs.version }}.tar.gz"
            echo "cd git-issue-${{ steps.tag.outputs.version }}"
            echo "sudo make install"
            echo "# Or user install:"
            echo "make install prefix=~/.local"
            echo '```'
            echo ""
            echo "## Verification"
            echo '```bash'
            echo "git issue version"
            echo '```'
            echo ""
            echo "## SHA256"
            echo '```'
            echo "${{ steps.tarball.outputs.sha256 }}"
            echo '```'
          } >> RELEASE_NOTES.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: ${{ steps.tarball.outputs.tarball }}
          fail_on_unmatched_files: true

      - name: Update Homebrew formula automatically
        if: github.event_name == 'push'
        run: |
          # Update Formula/git-issue.rb with new version, SHA256, and URL
          VERSION="${{ steps.tag.outputs.version_number }}"
          SHA256="${{ steps.tarball.outputs.sha256 }}"
          URL="https://github.com/remenoscodes/git-issue/releases/download/${{ steps.tag.outputs.version }}/git-issue-${{ steps.tag.outputs.version }}.tar.gz"

          # Update the formula file
          sed -i.bak "s|url \".*\"|url \"$URL\"|g" Formula/git-issue.rb
          sed -i.bak "s|sha256 \".*\"|sha256 \"$SHA256\"|g" Formula/git-issue.rb
          sed -i.bak "s|version \".*\"|version \"$VERSION\"|g" Formula/git-issue.rb
          rm -f Formula/git-issue.rb.bak

          # Check if formula was actually updated
          if git diff --quiet Formula/git-issue.rb; then
            echo "⚠️  Formula unchanged (already up to date)"
          else
            echo "✓ Formula updated:"
            echo "  version: $VERSION"
            echo "  sha256: $SHA256"
            echo "  url: $URL"
            git diff Formula/git-issue.rb
          fi

      - name: Commit and push formula update
        if: github.event_name == 'push'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if git diff --quiet Formula/git-issue.rb; then
            echo "⚠️  No formula changes to commit"
            exit 0
          fi

          # Commit and push
          git add Formula/git-issue.rb
          git commit -m "Update Homebrew formula for ${{ steps.tag.outputs.version }}" \
                     -m "" \
                     -m "Automated update from release workflow:" \
                     -m "- Version: ${{ steps.tag.outputs.version_number }}" \
                     -m "- SHA256: ${{ steps.tarball.outputs.sha256 }}" \
                     -m "- Release: ${{ steps.tag.outputs.version }}" \
                     -m "" \
                     -m "This commit was automatically generated by GitHub Actions."
          git push origin main

          echo "✓ Formula committed and pushed to main"
          echo ""
          echo "Homebrew users can now install with:"
          echo "  brew install remenoscodes/git-issue/git-issue"
