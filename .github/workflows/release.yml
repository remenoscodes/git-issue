name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          # Use GITHUB_TOKEN with write permissions for pushing formula update
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Get version from tag
        id: tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "version_number=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Verify version in code matches tag
        run: |
          CODE_VERSION=$(grep -E '^VERSION=' bin/git-issue 2>/dev/null || echo "")
          if [ -z "$CODE_VERSION" ]; then
            echo "Warning: No VERSION variable found in bin/git-issue"
          else
            CODE_VERSION=$(echo "$CODE_VERSION" | sed 's/VERSION="\(.*\)"/\1/')
            TAG_VERSION="${{ steps.tag.outputs.version_number }}"
            if [ "$CODE_VERSION" != "$TAG_VERSION" ]; then
              echo "Error: Version mismatch!"
              echo "  Tag version: $TAG_VERSION"
              echo "  Code version: $CODE_VERSION"
              echo "Please update VERSION in bin/git-issue to match the tag"
              exit 1
            fi
            echo "✓ Version matches: $CODE_VERSION"
          fi

      - name: Create tarball
        run: |
          mkdir -p git-native-issue-${{ steps.tag.outputs.version }}

          # Copy all necessary files
          cp -r bin/ git-native-issue-${{ steps.tag.outputs.version }}/
          cp Makefile git-native-issue-${{ steps.tag.outputs.version }}/
          cp LICENSE git-native-issue-${{ steps.tag.outputs.version }}/
          cp README.md git-native-issue-${{ steps.tag.outputs.version }}/
          cp ISSUE-FORMAT.md git-native-issue-${{ steps.tag.outputs.version }}/
          cp install.sh git-native-issue-${{ steps.tag.outputs.version }}/

          # Copy documentation if it exists
          if [ -d doc ]; then
            cp -r doc/ git-native-issue-${{ steps.tag.outputs.version }}/
          fi

          # Create tarball
          tar czf git-native-issue-${{ steps.tag.outputs.version }}.tar.gz \
            git-native-issue-${{ steps.tag.outputs.version }}/

          # Compute SHA256
          SHA256=$(shasum -a 256 git-native-issue-${{ steps.tag.outputs.version }}.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "tarball=git-native-issue-${{ steps.tag.outputs.version }}.tar.gz" >> "$GITHUB_OUTPUT"

          echo "✓ Tarball created: git-native-issue-${{ steps.tag.outputs.version }}.tar.gz"
          echo "✓ SHA256: ${SHA256}"
        id: tarball

      - name: Test tarball installation
        run: |
          # Extract tarball
          tar xzf git-native-issue-${{ steps.tag.outputs.version }}.tar.gz
          cd git-native-issue-${{ steps.tag.outputs.version }}

          # Test make install
          make install prefix="${{ runner.temp }}/test-install"

          # Verify binaries installed
          test -f "${{ runner.temp }}/test-install/bin/git-issue" || exit 1
          test -x "${{ runner.temp }}/test-install/bin/git-issue" || exit 1

          # Test version command (if VERSION is in code)
          if grep -q "^VERSION=" bin/git-issue; then
            PATH="${{ runner.temp }}/test-install/bin:$PATH" git-issue version || true
          fi

          echo "✓ Tarball installation verified"

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## What's Changed" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          else
            echo "## Initial Release" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi

          # Add installation instructions
          {
            echo ""
            echo "## Installation"
            echo ""
            echo "### Homebrew (macOS/Linux)"
            echo '```bash'
            echo "brew install remenoscodes/git-native-issue/git-native-issue"
            echo '```'
            echo ""
            echo "### Install Script (Any POSIX System)"
            echo '```bash'
            echo "curl -sSL https://github.com/remenoscodes/git-native-issue/releases/download/${{ steps.tag.outputs.version }}/git-native-issue-${{ steps.tag.outputs.version }}.tar.gz | tar xz"
            echo "cd git-native-issue-${{ steps.tag.outputs.version }}"
            echo "sudo make install"
            echo '```'
            echo ""
            echo "### From Tarball"
            echo "Download \`git-native-issue-${{ steps.tag.outputs.version }}.tar.gz\` below, extract, and run:"
            echo '```bash'
            echo "tar xzf git-native-issue-${{ steps.tag.outputs.version }}.tar.gz"
            echo "cd git-native-issue-${{ steps.tag.outputs.version }}"
            echo "sudo make install"
            echo "# Or user install:"
            echo "make install prefix=~/.local"
            echo '```'
            echo ""
            echo "## Verification"
            echo '```bash'
            echo "git issue version"
            echo '```'
            echo ""
            echo "## SHA256"
            echo '```'
            echo "${{ steps.tarball.outputs.sha256 }}"
            echo '```'
            echo ""
            if [ -f "${{ steps.tarball.outputs.tarball }}.asc" ]; then
              echo "## GPG Signature Verification"
              echo "Verify the tarball authenticity:"
              echo '```bash'
              echo "# Import public key (first time only)"
              echo "gpg --keyserver keys.openpgp.org --recv-keys B71E4769AE500472"
              echo ""
              echo "# Verify signature"
              echo "gpg --verify git-native-issue-${{ steps.tag.outputs.version }}.tar.gz.asc git-native-issue-${{ steps.tag.outputs.version }}.tar.gz"
              echo '```'
              echo ""
            fi
          } >> RELEASE_NOTES.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: |
            ${{ steps.tarball.outputs.tarball }}
            ${{ steps.tarball.outputs.tarball }}.asc
          fail_on_unmatched_files: false

      - name: Trigger Homebrew tap formula update
        if: github.event_name == 'push'
        run: |
          VERSION="${{ steps.tag.outputs.version_number }}"
          SHA256="${{ steps.tarball.outputs.sha256 }}"
          URL="https://github.com/remenoscodes/git-native-issue/releases/download/${{ steps.tag.outputs.version }}/git-native-issue-${{ steps.tag.outputs.version }}.tar.gz"

          echo "Triggering formula update in homebrew-git-native-issue tap..."
          echo "  version: $VERSION"
          echo "  sha256: $SHA256"
          echo "  url: $URL"

          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.TAP_UPDATE_TOKEN }}" \
            https://api.github.com/repos/remenoscodes/homebrew-git-native-issue/dispatches \
            -d "{\"event_type\":\"formula-update\",\"client_payload\":{\"version\":\"$VERSION\",\"sha256\":\"$SHA256\",\"url\":\"$URL\"}}"

          if [ $? -eq 0 ]; then
            echo "✓ Formula update triggered successfully"
            echo ""
            echo "Homebrew users can install with:"
            echo "  brew install remenoscodes/git-native-issue/git-native-issue"
          else
            echo "⚠️  Failed to trigger formula update"
            echo "Please update homebrew-git-native-issue manually"
            exit 1
          fi

      - name: Import GPG key
        if: github.event_name == 'push'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "⚠️  GPG_PRIVATE_KEY secret not set - skipping signature"
            echo "SKIP_GPG=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "✓ GPG key imported"
      
      - name: Sign release tarball
        if: github.event_name == 'push' && env.SKIP_GPG != 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          TARBALL="${{ steps.tarball.outputs.tarball }}"
          
          # Sign with GPG
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
              --armor --detach-sign "$TARBALL"
          else
            gpg --batch --yes --armor --detach-sign "$TARBALL"
          fi
          
          # Verify signature was created
          test -f "${TARBALL}.asc" || exit 1
          
          echo "✓ Tarball signed: ${TARBALL}.asc"
          echo "signature=${TARBALL}.asc" >> "$GITHUB_OUTPUT"
        id: sign
