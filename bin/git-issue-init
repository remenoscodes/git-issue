#!/bin/sh
#
# git-issue-init - Configure the current repo for issue tracking
#

set -e

usage() {
	cat <<EOF
usage: git issue init [<remote>]

Configure the current repository for git-issue tracking.
Adds the refs/issues/* fetch refspec to the specified remote (default: origin).
EOF
	exit 1
}

remote="origin"

while test $# -gt 0
do
	case "$1" in
		-h|--help)
			usage
			;;
		--)
			shift
			break
			;;
		-*)
			echo "error: unknown option '$1'" >&2
			usage
			;;
		*)
			remote="$1"
			shift
			;;
	esac
done

# Verify we are inside a git repository
	echo "fatal: not a git repository" >&2
	exit 128
}

# Verify the remote exists
if ! git remote | grep -qxF "$remote"
then
	echo "error: remote '$remote' does not exist" >&2
	echo "       available remotes: $(git remote | paste -sd', ' -)" >&2
	exit 1
fi

# Check if the refspec already exists
existing="$(git config --get-all "remote.$remote.fetch" 2>/dev/null || true)"
if printf '%s\n' "$existing" | grep -q 'refs/issues'
then
	printf 'git-issue: already configured for remote '\''%s'\''.\n' "$remote"
	exit 0
fi

# Add the fetch refspec for issues
git config --add "remote.$remote.fetch" '+refs/issues/*:refs/issues/*'
printf 'git-issue: configured. Issues will be fetched from %s.\n' "$remote"
printf 'Run '\''git fetch %s'\'' to pull existing issues.\n' "$remote"
