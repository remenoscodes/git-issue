#!/bin/sh
#
# git-issue-export - Export local issues to an external provider
#

set -e

usage() {
	cat <<EOF
usage: git issue export <provider> [options]

Supported providers:
   github:<owner>/<repo>        GitHub repository
   gitlab:<group>/<project>     GitLab project
   gitea:<owner>/<repo>         Gitea repository
   forgejo:<owner>/<repo>       Forgejo repository

Options:
   --dry-run         Show what would be exported without exporting
   -h, --help        Show this help

See 'git issue export <provider> --help' for provider-specific options.
EOF
	exit 1
}

provider=""
dry_run=0

while test $# -gt 0
do
	case "$1" in
		--dry-run)
			dry_run=1
			shift
			;;
		-h|--help)
			usage
			;;
		--)
			shift
			break
			;;
		-*)
			echo "error: unknown option '$1'" >&2
			usage
			;;
		*)
			if test -z "$provider"
			then
				provider="$1"
			fi
			shift
			;;
	esac
done

if test -z "$provider"
then
	echo "error: provider is required (e.g., github:owner/repo)" >&2
	usage
fi

# Find the directory containing the git-issue scripts
ISSUE_BIN_DIR="$(cd "$(dirname "$0")" && pwd)"

# Delegate to provider-specific script
case "$provider" in
	github:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-export-github" "$provider" --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-export-github" "$provider"
		fi
		;;
	gitlab:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-export-gitlab" "$provider" --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-export-gitlab" "$provider"
		fi
		;;
	gitea:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-export-gitea" "$provider" --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-export-gitea" "$provider"
		fi
		;;
	forgejo:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-export-gitea" "$provider" --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-export-gitea" "$provider"
		fi
		;;
	*)
		echo "error: unsupported or invalid provider '$provider'" >&2
		echo "       supported: github:<owner>/<repo>, gitlab:<group>/<project>, gitea:<owner>/<repo>, forgejo:<owner>/<repo>" >&2
		exit 1
		;;
esac
