#!/bin/sh
#
# git-issue-import - Import issues from an external provider
#

set -e

usage() {
	cat <<EOF
usage: git issue import <provider> [options]

Supported providers:
   github:<owner>/<repo>        GitHub repository
   gitlab:<group>/<project>     GitLab project
   gitea:<owner>/<repo>         Gitea repository
   forgejo:<owner>/<repo>       Forgejo repository

Options:
   --state <state>   Filter by state (default: open/opened)
   --dry-run         Show what would be imported without importing
   -h, --help        Show this help

See 'git issue import <provider> --help' for provider-specific options.
EOF
	exit 1
}

provider=""
state_filter="open"
dry_run=0

while test $# -gt 0
do
	case "$1" in
		--state)
			test $# -ge 2 || { echo "error: --state requires a value" >&2; exit 1; }
			case "$2" in
				open|closed|all) ;;
				*) echo "error: --state must be open, closed, or all" >&2; exit 1 ;;
			esac
			state_filter="$2"
			shift 2
			;;
		--dry-run)
			dry_run=1
			shift
			;;
		-h|--help)
			usage
			;;
		--)
			shift
			break
			;;
		-*)
			echo "error: unknown option '$1'" >&2
			usage
			;;
		*)
			if test -z "$provider"
			then
				provider="$1"
			fi
			shift
			;;
	esac
done

if test -z "$provider"
then
	echo "error: provider is required (e.g., github:owner/repo)" >&2
	usage
fi

# Find the directory containing the git-issue scripts
ISSUE_BIN_DIR="$(cd "$(dirname "$0")" && pwd)"

# Delegate to provider-specific script
case "$provider" in
	github:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-import-github" "$provider" ${state_filter:+--state "$state_filter"} --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-import-github" "$provider" ${state_filter:+--state "$state_filter"}
		fi
		;;
	gitlab:*/*)
		# Map 'open' -> 'opened' for GitLab terminology
		gitlab_state="$state_filter"
		test "$gitlab_state" = "open" && gitlab_state="opened"
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-import-gitlab" "$provider" ${gitlab_state:+--state "$gitlab_state"} --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-import-gitlab" "$provider" ${gitlab_state:+--state "$gitlab_state"}
		fi
		;;
	gitea:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-import-gitea" "$provider" ${state_filter:+--state "$state_filter"} --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-import-gitea" "$provider" ${state_filter:+--state "$state_filter"}
		fi
		;;
	forgejo:*/*)
		if test "$dry_run" -eq 1
		then
			exec "$ISSUE_BIN_DIR/git-issue-import-gitea" "$provider" ${state_filter:+--state "$state_filter"} --dry-run
		else
			exec "$ISSUE_BIN_DIR/git-issue-import-gitea" "$provider" ${state_filter:+--state "$state_filter"}
		fi
		;;
	*)
		echo "error: unsupported or invalid provider '$provider'" >&2
		echo "       supported: github:<owner>/<repo>, gitlab:<owner>/<project>, gitea:<owner>/<repo>, forgejo:<owner>/<repo>" >&2
		exit 1
		;;
esac
